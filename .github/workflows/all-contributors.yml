name: Update Contributors
on:
  push:
    branches:
      - main
    paths:
      - '.all-contributorsrc'  # 仅当贡献者配置文件变更时触发
  pull_request:
    branches:
      - main

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写权限来自动提交变更

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整提交历史

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # 推荐 LTS 版本
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run All Contributors
        uses: all-contributors/all-contributors-action@v4
        with:
          command: auto
          args: '--commit --skip-ci'  # 跳过 CI 的重复触发
          config-path: '.all-contributorsrc'  # 显式指定配置文件
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post cleanup
        if: always()
        run: |
          git stash  # 清理可能的临时变更
          git clean -fd
